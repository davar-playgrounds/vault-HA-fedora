---
- name: Install PHP staff and Apache
  dnf: name={{ item }} state=present
  with_items:
        - php
        - php-pear-Net-Curl
        - php-pecl-jsonc 

- name: Insert vault address for admin
  lineinfile: dest={{ vault_dir }}/.bashrc line="export VAULT_ADDR={{ vault_address }}"  insertafter=EOF state=present

- name: Copy consul config file
  template: src=client.json.j2 dest={{ consul_cfg_dir }}/client.json owner=consul group=consul
  register: consul_cfg

- name: Consul service reload
  service: name=consul.service state=reloaded enabled=yes
  when: consul_cfg.changed

- name: Allow Apache to connect
  seboolean: name=httpd_can_network_connect state=yes persistent=yes

- name: Apache service
  service: name=httpd.service state=started enabled=yes

- name: Deploy web page
  template: src=secret.php.j2 dest=/var/www/html/secret.php owner=root group=root mode=0644

- name: Check if vault was init
  shell: /bin/su - vault -c "vault init -check >/dev/null 2>&1"
  register: vault_init
  changed_when: vault_init.rc == 2
  failed_when: vault_init.rc == 1
  ignore_errors: yes
  
- name: Init vault
  shell: /bin/su - vault -c "vault init -key-shares=1 -key-threshold=1"
  register: vault_inited
  when: vault_init.changed

- block: 
        - name: Deploy vault keys
          template: src=vault.j2 dest=/etc/sysconfig/vault owner=root group=root mode=0600
          delegate_to: "{{item}}"
          with_items: "{{groups['servers']}}"

        - name: Deploy root token to vault user
          template: src=vault-token.j2 dest={{ vault_dir }}/.vault-token owner=vault group=vault mode=0600
          delegate_to: "{{item}}"
          with_items: 
                - "{{groups['servers']}}"
                - client

        - name: Restart vault cluster
          service: name=vault.service state=restarted enabled=yes
          delegate_to: "{{ item }}"
          with_items: "{{groups['servers']}}"
  when: vault_inited.changed

- block:
        - name: Create secret
          command: /bin/su - vault -c "vault write /secret/foo value='Top secret!'"

        - name: Copy policy
          copy: src=policy.hcl dest=/tmp/policy.hcl owner=vault group=vault mode=0600 mode=0644

        - name: Create policy
          command: /bin/su - vault -c "vault policy-write web /tmp/policy.hcl ; rm -f /tmp/policy.hcl" removes=/tmp/policy.hcl 

        - name: Enable userpass auth and create account
          shell: /bin/su - vault -c "vault auth-enable userpass ; vault write auth/userpass/users/{{ vault_user }} password={{ vault_password }} policies=web"
  when: vault_init.rc != 1
